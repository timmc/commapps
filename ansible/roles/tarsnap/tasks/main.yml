---
# TODO: Add check that commdata partition is mounted, then rotate all secrets

- name: Install Tarsnap deb packaging key
  apt_key:
    url: https://pkg.tarsnap.com/tarsnap-deb-packaging-key.asc
    state: present
    id: "8E64CEEC8767B49710E308F770BD6C50E82A9D99"

- name: Discover Debian codename
  shell: lsb_release --codename --short
  register: sh_debversion
  changed_when: False
  check_mode: no

- name: Use Tarsnap package repository
  copy:
    content: |
      # Ansible: remote-backup role
      deb http://pkg.tarsnap.com/deb/{{ sh_debversion.stdout }} ./
    dest: /etc/apt/sources.list.d/tarsnap.list

- name: Install tarsnap
  apt: name=tarsnap

- name: Directory for tarsnap secrets
  file:
    state: directory
    path: /srv/commdata/backups/secrets
    owner: root
    group: root
    mode: 0600

- name: Tarsnap key file
  copy:
    content: "{{ commdata_tarsnap_rw_key }}"
    dest: /srv/commdata/backups/secrets/tarsnap-rw.key
    owner: root
    group: root
    mode: 0600
  no_log: true

- name: A place for tarsnap scripts
  file:
    state: directory
    path: /opt/commapps/backups
    owner: root
    group: root
    mode: 0755

- name: Install backup script
  copy:
    src: "{{ role_path }}/files/run-backup.sh"
    dest: /opt/commapps/backups/run-backup.sh
    owner: root
    group: root
    mode: 0755

- name: Install archive listing script
  copy:
    src: "{{ role_path }}/files/list-archives.sh"
    dest: /opt/commapps/backups/list-archives.sh
    owner: root
    group: root
    mode: 0755

- name: Install archive restore script
  copy:
    src: "{{ role_path }}/files/restore-archive.sh"
    dest: /opt/commapps/backups/restore-archive.sh
    owner: root
    group: root
    mode: 0755

- name: Install cron job
  copy:
    src: "{{ role_path }}/files/cron"
    dest: /etc/cron.d/sandstorm-backup # TODO move
    owner: root
    group: root
    mode: 0644
