# A playbook to install ansible public keys as authorized key for the
# root user on a newly set up host.
#
# Usage:
#
# HOSTNAME=kibble
# USER=pi
# HOSTADDR=$HOSTNAME.internal
# PUBKEY=roles/common/files/id_ansible_appux.pub
# ansible-playbook bootstrap.yml --ask-pass --become --become-user=root --ask-become-pass --extra-vars="root_authkeys_path=$PUBKEY hostname=$HOSTNAME" --inventory="$HOSTADDR," --user="$USER"

---
- hosts: all
  tasks:
  - name: Ensure root has valid .ssh dir
    file:
      state: directory
      path: /root/.ssh
      owner: root
      group: root
      mode: 0700
  - name: Ensure ansible root pubkey is authorized for root
    copy:
      src: "{{ root_authkeys_path }}"
      dest: /root/.ssh/authorized_keys
      owner: root
      group: root
      mode: 0644
  - name: Set hostname
    hostname:
      name: "{{ hostname }}"
  - name: Update software
    apt:
      update_cache: yes
      upgrade: dist
